
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Lab 5: Commercial FM &#8212; ECE447 Course Webpage</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'labs/Lab5b';</script>
    <link rel="icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo.png" class="logo__image only-light" alt="ECE447 Course Webpage - Home"/>
    <script>document.write(`<img src="../_static/logo.png" class="logo__image only-dark" alt="ECE447 Course Webpage - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    Welcome to ECE447, Communication Systems!
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Course Info</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../syllabus.html">Syllabus</a></li>
<li class="toctree-l1"><a class="reference internal" href="../schedule.html">Course Schedule</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Course Downloads</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../downloads.html">Slides and Downloads</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Assignments and Labs</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../HW/SkillsReview.html">Skills Review</a></li>
<li class="toctree-l1"><a class="reference internal" href="Lab1.html">Lab 1: Installing SDR Receivers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../HW/HW1.html">Homework 1</a></li>
<li class="toctree-l1"><a class="reference internal" href="Lab2.html">Lab 2: Capturing Signals and Displaying Signals</a></li>
<li class="toctree-l1"><a class="reference internal" href="Lab3.html">Lab 3: Scanning for Signals, Modulation, and Decimation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../HW/HW2.html">Homework 2</a></li>
<li class="toctree-l1"><a class="reference internal" href="../HW/HW3.html">Homework 3</a></li>
<li class="toctree-l1"><a class="reference internal" href="Lab4.html">Lab 4: GNU Radio</a></li>
<li class="toctree-l1"><a class="reference internal" href="../HW/HW4.html">Homework 4</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/usafa-ece/jupyterbook-template" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/usafa-ece/jupyterbook-template/issues/new?title=Issue%20on%20page%20%2Flabs/Lab5b.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/labs/Lab5b.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Lab 5: Commercial FM</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#overview">Overview</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#aims-of-the-lab">Aims of the Lab</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#capturing-commercial-fm-signals">Capturing Commercial FM Signals</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#initial-decimation">Initial Decimation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#fm-decoding">FM Decoding</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#kpfa-and-subcarriers">KPFA and Subcarriers</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#wideband-fm-receiver">Wideband FM Receiver</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#lab-report">Lab Report</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="lab-5-commercial-fm">
<h1>Lab 5: Commercial FM<a class="headerlink" href="#lab-5-commercial-fm" title="Link to this heading">#</a></h1>
<p>(Adapted from Dr. John Pauly’s Stanford University EE179 course website: <a class="reference external" href="https://web.stanford.edu/class/ee179/Homework.html.">https://web.stanford.edu/class/ee179/Homework.html.</a>)</p>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Link to this heading">#</a></h2>
<p>So far we’ve looked at narrowband FM. This has a bandwidth of +/- 2.5 kHz, which is just find for voice communications, or low data rate digital voice or data. Music doesn’t sound very good at these rates, so the familiar commercial FM band has much wider channels with bandwidths of +/- 100 kHz. This is much more than actually required for the +/- 15 kHz that is the limit of human hearing (mine is much less!). This extra bandwidth has been exploited in many different ways. In this lab we’ll look at the technical archaeology of the FM signal. This includes the original mono band, the stereo signal, additional audio channels hidden on subcarriers, data channels, and high definition (HD) digital radio.</p>
</section>
<section id="aims-of-the-lab">
<h2>Aims of the Lab<a class="headerlink" href="#aims-of-the-lab" title="Link to this heading">#</a></h2>
<p>The goal of this lab are to decode commercial FM signals, and find and identify all of the different signals that are hidden inside it. This week we’ll just go after the mono channel.</p>
<p>One of the potential projects for the course is to go after the stereo channel, and the pilot reference channel that allows us to produce high fidelity stereo audio.</p>
</section>
<section id="capturing-commercial-fm-signals">
<h2>Capturing Commercial FM Signals<a class="headerlink" href="#capturing-commercial-fm-signals" title="Link to this heading">#</a></h2>
<p>First, we need to capture some signals to play with. Capture 10 seconds of data centered at 105.3 MHz, sampled at 2.048 MHz. This will include a number of high SNR stations that have interesting signals to look at. Also, capture 10 second of data for KPFA at 94.1 MHz. This has some unusual signals that we will look at first. As usual, the capture is done with</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="o">./</span><span class="n">rtl_sdr</span> <span class="o">-</span><span class="n">f</span> <span class="mi">105300000</span> <span class="o">-</span><span class="n">s</span> <span class="mi">2048000</span> <span class="o">-</span><span class="n">n</span> <span class="mi">20480000</span> <span class="n">wfm1053_10s</span><span class="o">.</span><span class="n">dat</span>
</pre></div>
</div>
<p>where the “&gt;” character is your command line prompt, and will undoubtedly be something different (this is what I set it to). These are strong enough signals we can tune to the stations directly, and not worry about the DC artifact.</p>
<p>Two example files are</p>
<p><a class="reference download internal" download="" href="../_downloads/7e11bd2e456afaf481fd4e35fe99bae7/wfm941_10s.dat"><span class="xref download myst">wfm941_10s.dat</span></a><br />
<a class="reference download internal" download="" href="../_downloads/4bd228946660147673e8ddae0adadfc2/wfm1053_10s.dat"><span class="xref download myst">wfm1053_10s.dat</span></a></p>
<p>in case you are having trouble picking up good signals.</p>
<p>First, look at a spectrogram of the signals, to see what is out there. If you look at the spectrogram centered at 94.1 MHz, you will see something like this</p>
<p><img alt="" src="../_images/msg_941.png" /></p>
<p>The total bandwidth is 2.048 MHz. The FM channels are 200 kHz in width, and normally only alternate channels are allocated in one geographic area. As a result, we see five clear channels. The spectra look very different, and we’ll see why when we decode them. All of these are analog commercial FM signals.</p>
<p>The spectrogram centered at 105.3 MHz looks a little different</p>
<p><img alt="" src="../_images/msg_1053.png" /></p>
<p>This part of the spectrum is more densely occupied. Several of the spectra here are very different. Again, we’ll see why shortly. More interesting are the square gray stripes. These are digital, or HD, radio. These are increasingly common, as HD radio becomes more popular in new cars. There is a stark contrast between the analog FM signals and the digital HD signals. Digital signals look like noise with a very well defined bandwidth, because they maximally exploit the frequency band they are allocated. Actually, two HD channels can exist in one of these stripes. Analog FM, on the other hand, is less efficient. You can clearly identify the signal that is being encoded from the spectrogram. There is lots of empty space in the analog FM signal spectrogram, that could be used to encode other information. However, even the analog FM channels encode lots of different signals!</p>
<p>If your spectra aren’t as clean, it may be that your sdr is saturating. What you’ll see is your spectrum at DC, plus ghosts of the spectrum. It looks like this for 94.1 MHz</p>
<p><img alt="" src="../_images/msg_941_sat.png" /></p>
<p>The top spectra is a distorted copy of the middle spectra. Most of the other signals are gone. Interestingly, you can still decode the signal at 94.1 MHz fairly reasonably, but the other signals are seriously corrupted. You can fix this by manually setting the gain of the sdr. If you run ‘rtl_test’ it will report the gains that are available. Then use the ’-g’ switch to set one of these for ‘rtl_sdr’. For example, I used ’-g 40.7’ for the data files available above. You may need even less gain, depending on where you are, and how well these stations come in.</p>
</section>
<section id="initial-decimation">
<h2>Initial Decimation<a class="headerlink" href="#initial-decimation" title="Link to this heading">#</a></h2>
<p>We’ll start by going after the signals where we centered the receiver (94.1 MHz, and 105.3 MHz). We can also go after the other signals, but we’ll have to demodulate them to baseband first, just as we did with the narrowband signals last week. Since the signals are all separated by multiples of 200 kHz, this is pretty easy to do.</p>
<p>We are sampling at 2.048 MHz, and the signal bandwidths are 200 kHz, so we need to decimate by a factor of about 10. We are going to want to process the signal right out the the +/- 100 kHz band edge, so we will want to sample a little above this to make the filters easy to design. Load your data file, and decimate it down by a factor of 8, to give you a sampling frequency of 256 kHz, or a signal bandwidth of +/- 128 kHz.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">drf</span> <span class="o">=</span> <span class="n">loadFile</span><span class="p">(</span><span class="s1">&#39;wfm1053_10s.dat&#39;</span><span class="p">);</span> <span class="o">%</span> <span class="n">Load</span> <span class="n">RF</span> <span class="n">Data</span>
<span class="o">&gt;</span> <span class="n">d</span> <span class="o">=</span> <span class="n">decimate</span><span class="p">(</span><span class="n">drf</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="s1">&#39;fir&#39;</span><span class="p">);</span>         <span class="o">%</span> <span class="n">decimate</span> <span class="n">to</span> <span class="mi">256</span> <span class="n">kHz</span>
</pre></div>
</div>
<p>For the 94.1 MHz data, the spectrogram should look like this</p>
<p><img alt="" src="../_images/msg_941_dec.png" /></p>
<p>There is lots of intriguing structure in this spectrogram! In particular, why are there three almost parallel copies of the spectrum superimposed? This will be clearer after we do the FM detection.</p>
</section>
<section id="fm-decoding">
<h2>FM Decoding<a class="headerlink" href="#fm-decoding" title="Link to this heading">#</a></h2>
<p>Last week we used a simple method for decoding the FM signal. If the decimated data was in ‘d’, then</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">dfm</span> <span class="o">=</span> <span class="n">angle</span><span class="p">(</span><span class="n">conj</span><span class="p">(</span><span class="n">d</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">end</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">.*</span><span class="n">d</span><span class="p">(</span><span class="mi">2</span><span class="p">:</span><span class="n">end</span><span class="p">))));</span>
</pre></div>
</div>
<p>where the angle() command could be replaced by imag(). The reason this works is the conj(d(1:end-1)) operator negates the phase of d. After the dot product with the delated signal d(2:end), we get the product of the magnitudes (which we don’t care about), and the difference of the phases (which has the FM data). Taking the angle extracts the FM data, while ignoring the amplitude variation.</p>
<p>The problem with this for the commercial FM signal is that a first difference operation is only a good approximation to a differentiator for frequencies that are much less than the sampling rate. In this case we want to extract FM signals right out the the band edge, so we need a better processing scheme. Assume we have demodulated one sideband of the FM signal, so our RF data is <span class="math notranslate nohighlight">\(d(t)  = a(t) e^{j (2\pi f_c t + k\int_0^t m(s)ds)}\)</span> where <span class="math notranslate nohighlight">\(m(t)\)</span> is the FM signal. If we demodulate to center the FM signal, then <span class="math notranslate nohighlight">\(f_c = 0\)</span>, and we can drop that term, leaving us with <span class="math notranslate nohighlight">\(d(t)  = a(t) e^{j k\int_0^t m(s) ds}\)</span>. The leading coefficient <span class="math notranslate nohighlight">\(a(t)\)</span> is variation in the signal amplitude, which doesn’t carry any useful information. We’ll first divide that out. This does what the limiter does in the block diagrams we looked at in class.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">dl</span> <span class="o">=</span> <span class="n">d</span><span class="o">./</span><span class="nb">abs</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>   <span class="o">%</span> <span class="n">Eliminate</span> <span class="n">amplitude</span> <span class="n">variations</span>
</pre></div>
</div>
<p>We didn’t need this last time because of the way we directly differentiated the phase, and then extracted the angle. This time we have to eliminate this variation first. Our signal now is <span class="math notranslate nohighlight">\(d_l(t)  =  e^{j k \int_0^t m(s)ds}\)</span>.</p>
<p>What we really want is <span class="math notranslate nohighlight">\(m(t)\)</span>. We can get this by computing</p>
<div class="math notranslate nohighlight">
\[\left(\frac{d}{dt} d_l(t)\right) d_l^*(t)  = (j k m(t)) e^{j k\int_0^t m(s)ds} e^{-j k \int_0^t m(s)ds} = j k m(t)\]</div>
<p>Hence, we just take our limited signal <span class="math notranslate nohighlight">\(d_l(t)\)</span>, differentiate it, and multiply it by the conjugate of the original signal, and we get the message signal in the imaginary channel.</p>
<p>The only trick is doing a good job of differentiation. We’ll do that with an FIR filter. You can skip the next paragraph if you aren’t interested in the details. The impulse response for a differentiator is included below.</p>
<p>There are a number of MATLAB routines that design differentiators. I like <code class="docutils literal notranslate"><span class="pre">firls()</span></code> which designs FIR filters using a least squares error criteria. Another is <code class="docutils literal notranslate"><span class="pre">firpm()</span></code> that designs minimax (equalripple) filters. However, there are some oddities. Look at the documentation for <code class="docutils literal notranslate"><span class="pre">firls()</span></code> to see what it does. We want a differentiator with an odd length, so that it will have perfectly linear phase (an even length differentiator will have a half sample delay). For our needs, a differentiator of length 31 should do. That means we want to ask for a design of order 30! The filter is always one sample longer than the order we ask for. The next argument to <code class="docutils literal notranslate"><span class="pre">firls()</span></code> is an array with the band edges. We want the differentiator to go from 0 Hz to 100 kHz and don’t care what it is from 100 kHz to 128 kHz. We’ll just specify a narrow stop band right at 128 kHz, since it has to go through zero there anyway. Frequencies are normalized to half the sampling rate (another oddity) so we divide by that. Next, we need an array to specify the amplitudes at the band edges. That is 0 and 0 Hz, 1 at 100 kHz, and 0 in the stop band. The final argument is the type of filter we what, so we specify ‘differentiator’.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="o">%</span>
<span class="o">&gt;</span> <span class="o">%</span> <span class="n">design</span> <span class="n">the</span> <span class="n">differentiator</span>
<span class="o">&gt;</span> <span class="o">%</span>
<span class="o">&gt;</span> <span class="n">hd</span> <span class="o">=</span> <span class="n">firls</span><span class="p">(</span><span class="mi">30</span><span class="p">,[</span><span class="mi">0</span> <span class="mi">100000</span> <span class="mi">127000</span> <span class="mi">128000</span><span class="p">]</span><span class="o">/</span><span class="mi">128000</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span> <span class="mi">1</span> <span class="mi">0</span> <span class="mi">0</span><span class="p">],</span><span class="s1">&#39;differentiator&#39;</span><span class="p">);</span>
<span class="o">&gt;</span> <span class="o">%</span>
<span class="o">&gt;</span> <span class="o">%</span> <span class="n">Plot</span> <span class="n">the</span> <span class="nb">filter</span><span class="p">,</span> <span class="ow">and</span> <span class="n">its</span> <span class="n">frequency</span> <span class="n">response</span>
<span class="o">&gt;</span> <span class="o">%</span>
<span class="o">&gt;</span> <span class="n">subplot</span><span class="p">(</span><span class="mi">211</span><span class="p">);</span>
<span class="o">&gt;</span> <span class="n">stem</span><span class="p">(</span><span class="n">hd</span><span class="p">);</span>
<span class="o">&gt;</span> <span class="n">subplot</span><span class="p">(</span><span class="mi">212</span><span class="p">);</span>
<span class="o">&gt;</span> <span class="n">f</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">128</span><span class="p">:</span><span class="mi">127</span><span class="p">];</span>
<span class="o">&gt;</span> <span class="n">plot</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="nb">abs</span><span class="p">(</span><span class="n">fftshift</span><span class="p">(</span><span class="n">fft</span><span class="p">([</span><span class="n">hd</span> <span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">256</span><span class="o">-</span><span class="mi">31</span><span class="p">)]))));</span>
</pre></div>
</div>
<p>The result should look like this</p>
<p><img alt="" src="../_images/diff_plot.png" /></p>
<p>The response is very linear, right out to 100 kHz. We’ve plotted the absolute value. The response for negative frequencies is actually negative, so that the response is linear from -100 kHz to 100 kHz.</p>
<p>If you don’t have the MATLAB signal processing toolbox, or are using octave, this filter is available here for your convenience:</p>
<p><a class="reference download internal" download="" href="../_downloads/09fb2234992ceade3b6c0197aacba437/hd.mat"><span class="xref download myst">hd.mat</span></a></p>
<p>With the FIR differentiator, we can extract the FM signal with the command</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">df</span> <span class="o">=</span> <span class="n">imag</span><span class="p">(</span><span class="n">conv</span><span class="p">(</span><span class="n">dl</span><span class="p">,</span><span class="n">hd</span><span class="p">,</span><span class="s1">&#39;same&#39;</span><span class="p">)</span><span class="o">.*</span><span class="n">conj</span><span class="p">(</span><span class="n">dl</span><span class="p">));</span>
</pre></div>
</div>
<p>The ‘same’ argument to <code class="docutils literal notranslate"><span class="pre">conv()</span></code> just keeps the central portion of the convolution (the middle 20480000 samples out of the 20480030 samples from the convolution, no one will miss those 30 samples!). This makes the dot product work without a complaint.</p>
</section>
<section id="kpfa-and-subcarriers">
<h2>KPFA and Subcarriers<a class="headerlink" href="#kpfa-and-subcarriers" title="Link to this heading">#</a></h2>
<p>The spectrogram of the result looks like this for the 94.1 MHz data</p>
<p><img alt="" src="../_images/msg_941_dec_fm.png" /></p>
<p>This is a lot simpler spectrogram than the previous one. We see lots of different signals. The spectral components are</p>
<p><img alt="" src="../_images/og_941_spec.png" /></p>
<p>Right in the middle is the mono signal, corresponding to the left+right stereo signal. The stereo signal is transmitted at L-R, centered at 38 kHz. There isn’t much energy in the L-R channel here. The stereo decomposition depends critically on the phase between the L+R and L-R channels. To make that easy to determine, a pilot signal is transmitted at 19 kHz to use as a reference.</p>
<p>We can decode and play the mono signal by decimating by a factor of 16 to a bandwidth of 256/16 = 16 kHz, and playing the result. We’ll decimate in two stages to be safe,</p>
<p>&gt; dfd = decimate(decimate(df,8,’fir’),2,’fir’);<br />
&gt; dfd = dfd / max(abs(dfd));<br />
&gt; sound(dfd,16000);</p>
<p>This should sound pretty good. The signal has too much high frequency emphasis, because we haven’t compensated for the equalization we talked about in class.</p>
<p>In addition, there are two other signals in the spectrum, centered at 67 kHz, and 92 kHz. These are subsidiary communications authorization (SCA) services. The FCC specifically doesn’t regulate the FM band from 57 kHz up to 100 kHz, only requiring that whatever you transmit there doesn’t interfere with the principle FM signal. For a long time this extra spectrum was used for Muzak, and other targeted FM signals. This has become less common with the advent of the internet, but there are still stations that use these channels. KPFA, which transmits on 94.1 MHz from Berkeley, transmits a Hatian-French subchannel at 67 kHz, and a Punjabi subchannel at 92 kHz.</p>
<p>Oddly enough, the subchannels themselves are FM encoded. This is like the Russian Matrushka dolls, with one inside another. Fortunately, you have all the tools you need to decode these signals! Start with the FM decoded signal df for 94.1 MHz. Demodulate the subcarrier frequencies of 67 kHz, and 92 kHz. Detect the FM signals (the methods you used last time for narrowband FM work fine here), and play back the audio. You will want to decimate to a bandwidth of 8kHz. In your lab report, describe what you hear (music, news, adds, interviews, etc).</p>
</section>
<section id="wideband-fm-receiver">
<h2>Wideband FM Receiver<a class="headerlink" href="#wideband-fm-receiver" title="Link to this heading">#</a></h2>
<p>Write an m-file that takes the RF data sampled at 2.048 MHz, demodulates a specified channel, and returns the mono component of the FM signal. Use this m-file to decode several of the other signals in the data files you captured.</p>
</section>
<section id="lab-report">
<h2>Lab Report<a class="headerlink" href="#lab-report" title="Link to this heading">#</a></h2>
<p>Upload to Gradescope a description of what you hear on the two KPFA subcarriers.</p>
<p>Demodulate at least two other FM channels in the data you captured (or the data sets provided above), and describe what their frequencies are, and what they are broadcasting.</p>
<!-- ## Potential Final Projects

One potential final project is to improve your FM decoder to get both L+R and L-R channels, and use the 19 kHz pilot to synchronise the two to produce stereo. There are several ways to do this.

Another potential project is to extract the RDS signal at 59 kHz and decode it.

For either of these are lots of online resources, which you are free to consult. Just make sure to cite them if you use something from them. --></section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./labs"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#overview">Overview</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#aims-of-the-lab">Aims of the Lab</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#capturing-commercial-fm-signals">Capturing Commercial FM Signals</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#initial-decimation">Initial Decimation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#fm-decoding">FM Decoding</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#kpfa-and-subcarriers">KPFA and Subcarriers</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#wideband-fm-receiver">Wideband FM Receiver</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#lab-report">Lab Report</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By DFEC
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2025.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>